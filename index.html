<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>性关系同意确认书（含手写签名和下载）</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        h1 {
            text-align: center;
            color: #444;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .disclaimer {
            background-color: #fff8e1;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .form-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: #555;
            font-size: 16px;
        }
        
        input[type="text"],
        input[type="datetime-local"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .agreement {
            margin: 25px 0;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 8px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 14px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 6px;
            transition: background-color 0.3s;
            width: 100%;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .signature-container {
            display: flex;
            flex-direction: column;
            margin-top: 30px;
        }
        
        .signature-wrapper {
            width: 100%;
            margin-bottom: 25px;
        }
        
        .signature-title {
            text-align: center;
            margin-bottom: 12px;
            font-weight: bold;
            font-size: 16px;
        }
        
        .signature-pad-container {
            position: relative;
            width: 100%;
            height: 180px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
            overflow: hidden;
        }
        
        .signature-pad {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .signature-clear {
            display: block;
            margin-top: 8px;
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }
        
        .signature-clear:hover {
            background-color: #d32f2f;
        }
        
        .form-actions {
            display: flex;
            flex-direction: column;
            margin-top: 25px;
            gap: 12px;
        }
        
        #submitBtn {
            order: 1;
        }
        
        #downloadBtn {
            background-color: #2196F3;
            display: none;
            order: 2;
        }
        
        #downloadBtn:hover {
            background-color: #0b7dda;
        }
        
        .preview-container {
            display: none;
            margin-top: 30px;
            border: 1px solid #ddd;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
        }
        
        .preview-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            font-size: 20px;
        }
        
        .preview-content {
            line-height: 1.8;
            font-size: 16px;
        }
        
        .preview-signatures {
            display: flex;
            flex-direction: column;
            margin-top: 30px;
            gap: 20px;
        }
        
        .preview-signature {
            text-align: center;
        }
        
        .preview-signature-img {
            max-height: 100px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
            margin-bottom: 8px;
            max-width: 100%;
        }

        @media (min-width: 768px) {
            .signature-container {
                flex-direction: row;
                gap: 20px;
            }
            
            .signature-wrapper {
                width: calc(50% - 10px);
            }
            
            .form-actions {
                flex-direction: row;
            }
            
            #submitBtn, #downloadBtn {
                width: auto;
                flex: 1;
            }
            
            .preview-signatures {
                flex-direction: row;
                justify-content: space-around;
            }
            
            .preview-signature {
                width: 45%;
            }
        }
    </style>
</head>
<body>
    <h1>性关系同意确认书</h1>
    
    <div class="disclaimer">
        <strong>重要声明：</strong>本确认书仅作为双方自愿发生性关系的记录工具，不能替代法律文书。所有信息将加密存储，仅用于法律需要时作为证据使用。
    </div>
    
    <div class="form-container">
        <form id="consentForm">
            <div class="form-section">
                <span class="section-title">男方信息</span>
                <input type="text" id="maleName" name="maleName" placeholder="男方姓名" required>
                <input type="text" id="maleID" name="maleID" placeholder="男方身份证号码" required pattern="\d{17}[\dXx]">
            </div>
            
            <div class="form-section">
                <span class="section-title">女方信息</span>
                <input type="text" id="femaleName" name="femaleName" placeholder="女方姓名" required>
                <input type="text" id="femaleID" name="femaleID" placeholder="女方身份证号码" required pattern="\d{17}[\dXx]">
            </div>
            
            <div class="form-section">
                <span class="section-title">发生关系时间</span>
                <input type="datetime-local" id="relationTime" name="relationTime" required>
            </div>
            
            <div class="agreement">
                <div class="checkbox-container">
                    <input type="checkbox" id="consentCheckbox" name="consent" required>
                    <label for="consentCheckbox">我确认双方自愿发生关系，且不反悔</label>
                </div>
            </div>
            
            <div class="signature-container">
                <div class="signature-wrapper">
                    <div class="signature-title">男方签名</div>
                    <div class="signature-pad-container">
                        <canvas id="maleSignature" class="signature-pad"></canvas>
                    </div>
                    <button type="button" class="signature-clear" onclick="clearSignature('male')">清除签名</button>
                </div>
                
                <div class="signature-wrapper">
                    <div class="signature-title">女方签名</div>
                    <div class="signature-pad-container">
                        <canvas id="femaleSignature" class="signature-pad"></canvas>
                    </div>
                    <button type="button" class="signature-clear" onclick="clearSignature('female')">清除签名</button>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" id="submitBtn">提交确认</button>
                <button type="button" id="downloadBtn" onclick="downloadConsent()">下载同意书</button>
            </div>
        </form>
        
        <div id="previewContainer" class="preview-container">
            <div class="preview-title">性关系同意确认书</div>
            <div id="previewContent" class="preview-content">
                <!-- 动态生成的内容将在这里显示 -->
            </div>
            <div class="preview-signatures">
                <div class="preview-signature">
                    <div>男方签名：</div>
                    <img id="previewMaleSignature" class="preview-signature-img" src="">
                    <div id="previewMaleName"></div>
                </div>
                <div class="preview-signature">
                    <div>女方签名：</div>
                    <img id="previewFemaleSignature" class="preview-signature-img" src="">
                    <div id="previewFemaleName"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化签名板
        let maleSignaturePad, femaleSignaturePad;
        let currentFormData = null;
        
        // 高清初始化签名板
        function initSignaturePad(canvas) {
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            
            // 设置canvas的物理尺寸
            canvas.width = rect.width * ratio;
            canvas.height = rect.height * ratio;
            
            // 设置canvas的显示尺寸
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            const signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: '#000000',
                minWidth: 1.5,
                maxWidth: 2.5,
                throttle: 16,
                velocityFilterWeight: 0.7
            });

            // 修复触摸事件坐标问题
            if ('ontouchstart' in window) {
                const handleTouchStart = (e) => {
                    if (e.target === canvas) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const rect = canvas.getBoundingClientRect();
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        const mouseEvent = new MouseEvent('mousedown', {
                            clientX: touch.clientX,
                            clientY: touch.clientY,
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        canvas.dispatchEvent(mouseEvent);
                    }
                };

                const handleTouchMove = (e) => {
                    if (e.target === canvas) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const mouseEvent = new MouseEvent('mousemove', {
                            clientX: touch.clientX,
                            clientY: touch.clientY,
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        canvas.dispatchEvent(mouseEvent);
                    }
                };

                const handleTouchEnd = (e) => {
                    if (e.target === canvas) {
                        e.preventDefault();
                        const mouseEvent = new MouseEvent('mouseup', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        canvas.dispatchEvent(mouseEvent);
                    }
                };

                canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            }

            return signaturePad;
        }
        
        // 防止滚动
        function preventScroll(e) {
            if (e.target.classList.contains('signature-pad')) {
                e.preventDefault();
            }
        }
        
        // 更新签名板尺寸
        function updateSignaturePadSize(signaturePad, canvas) {
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            
            const oldData = signaturePad.toData();
            
            canvas.width = rect.width * ratio;
            canvas.height = rect.height * ratio;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            
            signaturePad.clear();
            if (oldData) {
                signaturePad.fromData(oldData);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const consentCheckbox = document.getElementById('consentCheckbox');
            const submitBtn = document.getElementById('submitBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const form = document.getElementById('consentForm');
            const previewContainer = document.getElementById('previewContainer');
            const maleCanvas = document.getElementById('maleSignature');
            const femaleCanvas = document.getElementById('femaleSignature');
            
            // 初始化签名板
            maleSignaturePad = initSignaturePad(maleCanvas);
            femaleSignaturePad = initSignaturePad(femaleCanvas);
            
            // 添加移动端支持
            ['touchstart', 'touchmove', 'touchend'].forEach(event => {
                maleCanvas.addEventListener(event, preventScroll, { passive: false });
                femaleCanvas.addEventListener(event, preventScroll, { passive: false });
            });
            
            // 窗口大小变化时重设canvas
            const resizeObserver = new ResizeObserver(() => {
                updateSignaturePadSize(maleSignaturePad, maleCanvas);
                updateSignaturePadSize(femaleSignaturePad, femaleCanvas);
            });
            
            resizeObserver.observe(maleCanvas.parentElement);
            resizeObserver.observe(femaleCanvas.parentElement);
            
            // 启用/禁用提交按钮
            consentCheckbox.addEventListener('change', function() {
                updateSubmitButton();
            });
            
            // 监听签名变化
            maleSignaturePad.addEventListener('endStroke', updateSubmitButton);
            femaleSignaturePad.addEventListener('endStroke', updateSubmitButton);
            
            // 身份证验证
            function validateID(id) {
                const reg = /^\d{17}[\dXx]$/;
                return reg.test(id);
            }
            
            // 更新提交按钮状态
            function updateSubmitButton() {
                const isConsentChecked = consentCheckbox.checked;
                const isMaleSigned = !maleSignaturePad.isEmpty();
                const isFemaleSigned = !femaleSignaturePad.isEmpty();
                
                submitBtn.disabled = !(isConsentChecked && isMaleSigned && isFemaleSigned);
            }
            
            // 表单提交
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const maleID = document.getElementById('maleID').value;
                const femaleID = document.getElementById('femaleID').value;
                
                if (!validateID(maleID)) {
                    alert('请输入有效的男方身份证号码');
                    return;
                }
                
                if (!validateID(femaleID)) {
                    alert('请输入有效的女方身份证号码');
                    return;
                }
                
                if (maleSignaturePad.isEmpty()) {
                    alert('请男方提供手写签名');
                    return;
                }
                
                if (femaleSignaturePad.isEmpty()) {
                    alert('请女方提供手写签名');
                    return;
                }
                
                // 收集表单数据
                currentFormData = {
                    maleName: document.getElementById('maleName').value,
                    maleID: maleID,
                    femaleName: document.getElementById('femaleName').value,
                    femaleID: femaleID,
                    relationTime: document.getElementById('relationTime').value,
                    maleSignature: maleSignaturePad.toDataURL('image/png'),
                    femaleSignature: femaleSignaturePad.toDataURL('image/png'),
                    timestamp: new Date().toISOString()
                };
                
                // 显示预览
                showPreview(currentFormData);
                
                // 显示下载按钮
                downloadBtn.style.display = 'block';
                
                // 滚动到预览区域
                previewContainer.scrollIntoView({ behavior: 'smooth' });
            });
        });
        
        // 清除签名
        function clearSignature(gender) {
            if (gender === 'male') {
                maleSignaturePad.clear();
            } else {
                femaleSignaturePad.clear();
            }
            updateSubmitButton();
        }
        
        // 显示预览
        function showPreview(data) {
            const previewContainer = document.getElementById('previewContainer');
            const previewContent = document.getElementById('previewContent');
            
            // 格式化日期时间
            const formatDateTime = (datetimeStr) => {
                if (!datetimeStr) return '';
                const dt = new Date(datetimeStr);
                return dt.toLocaleString('zh-CN');
            };

            // 生成预览内容
            previewContent.innerHTML = `
                <p><strong>男方信息：</strong></p>
                <p>姓名：${data.maleName}</p>
                <p>身份证号码：${data.maleID.replace(/(\d{4})\d+(\d{4})/, '\$1********\$2')}</p>
                
                <p><strong>女方信息：</strong></p>
                <p>姓名：${data.femaleName}</p>
                <p>身份证号码：${data.femaleID.replace(/(\d{4})\d+(\d{4})/, '\$1********\$2')}</p>
                
                <p><strong>发生关系时间：</strong>${formatDateTime(data.relationTime)}</p>
                
                <p><strong>确认条款：</strong></p>
                <p>双方确认自愿发生关系，且不反悔。</p>
                
                <p><strong>提交时间：</strong>${formatDateTime(data.timestamp)}</p>
            `;
            
            // 显示签名
            document.getElementById('previewMaleSignature').src = data.maleSignature;
            document.getElementById('previewFemaleSignature').src = data.femaleSignature;
            document.getElementById('previewMaleName').textContent = data.maleName;
            document.getElementById('previewFemaleName').textContent = data.femaleName;
            
            // 显示预览区域
            previewContainer.style.display = 'block';
        }
        
        // 下载同意书
        function downloadConsent() {
            if (!currentFormData) {
                alert('请先提交表单');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // 添加标题
            doc.setFontSize(18);
            doc.text('性关系同意确认书', 105, 20, { align: 'center' });
            
            // 设置正文样式
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            // 添加男方信息
            doc.text(`男方姓名：${currentFormData.maleName}`, 20, 40);
            doc.text(`身份证号：${currentFormData.maleID.replace(/(\d{4})\d+(\d{4})/, '$1********$2')}`, 20, 50);
            
            // 添加女方信息
            doc.text(`女方姓名：${currentFormData.femaleName}`, 20, 70);
            doc.text(`身份证号：${currentFormData.femaleID.replace(/(\d{4})\d+(\d{4})/, '$1********$2')}`, 20, 80);
            
            // 添加时间信息
            const formatDateTime = (datetimeStr) => {
                if (!datetimeStr) return '';
                const dt = new Date(datetimeStr);
                return dt.toLocaleString('zh-CN');
            };
            
            doc.text(`发生关系时间：${formatDateTime(currentFormData.relationTime)}`, 20, 100);
            doc.text(`提交时间：${formatDateTime(currentFormData.timestamp)}`, 20, 110);
            
            // 添加确认条款
            doc.text('确认条款：', 20, 130);
            doc.text('双方确认自愿发生关系，且不反悔。', 20, 140);
            
            // 添加签名
            const maleImg = new Image();
            maleImg.src = currentFormData.maleSignature;
            
            const femaleImg = new Image();
            femaleImg.src = currentFormData.femaleSignature;

            // 等待图片加载
            Promise.all([
                new Promise(resolve => { maleImg.onload = resolve; }),
                new Promise(resolve => { femaleImg.onload = resolve; })
            ]).then(() => {
                // 添加男方签名
                doc.addImage(maleImg, 'PNG', 30, 160, 60, 30);
                doc.text(`${currentFormData.maleName} 签名`, 30, 195);
                
                // 添加女方签名
                doc.addImage(femaleImg, 'PNG', 120, 160, 60, 30);
                doc.text(`${currentFormData.femaleName} 签名`, 120, 195);
                
                // 保存PDF
                doc.save(`性关系同意确认书_${new Date().toISOString().slice(0,10)}.pdf`);
            });
        }
    </script>
</body>
</html>
